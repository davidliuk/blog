# 缓存问题：穿透、击穿、雪崩

## 缓存穿透

Pass Through

### 概念

客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。

### 被动方案

- 缓存空对象
  - 优点：实现简单，维护方便
  - 缺点：
    - 额外的内存消耗（不过可以通过 TTL 来缓解）
    - 可能造成短期的不一致
  
- 布隆过滤
  - 优点：内存占用比较少，没有多余 key
  
  - 缺点：
    - 实现复杂（hash + bitmap + 概率实现的）
    
    - 存在误判可能
    
      说不存在一定不存在，但是说存在的时候也有一定概率是不存在的

![image-20221207214912970](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/image-20221207214912970.png)

### 主动方案

- 增强 id 的复杂度，避免被猜测 id 规律，来渗透数据库
- 做好数据的基础格式校验（如长度，雪花算法）
- 加强用户权限校验
- 做好热点参数的限流 （spring cloud sentinel）

## 缓存雪崩

### 概念

同一时段大量的缓存 key 同时失效或者 Redis 服务宕机，导致大量请求到达数据库，带来巨大压力。

![image-20221207221534423](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/image-20221207221534423.png)

### 解决方案

- 给不同的 key 的 TTL 添加随机值
- 利用 Redis 集群提高服务的可用性（高级篇：哨兵等）
- 给缓存业务添加降级限流策略（Spring Cloud 课里面）
- 给业务添加多级缓存（Spring Cloud 课里面）
  - 浏览器可以添加缓存（静态数据）
  - Nginx 缓存
  - JVM 缓存

## 缓存击穿

### 概念

又称**热点 key 问题**，就是一个被高并发访问并且缓存重建业务较复杂（耗时较长）的 key 突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。

![image-20221207222348234](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/image-20221207222348234.png)

### 解决方案

- 互斥锁

  性能比较差，好多别的线程在旁边自旋等待

- 逻辑过期，推荐！

  热点 key 在活动的时候，设计逻辑过期

![image-20221207225116155](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/image-20221207225116155.png)

双重判断锁

