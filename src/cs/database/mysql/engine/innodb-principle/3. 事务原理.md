# 事务原理

事务性质与

![截屏2023-02-24 23.15.51](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/%E6%88%AA%E5%B1%8F2023-02-24%2023.15.51.png)



## redo log

保证：持久性

该日志文件由两部分组成：

- 重做日志缓冲(redo log buffer)
- 重做日志文件(redo log file)

前者是在内存中，后者在磁盘中。当事务提交之后会把所有修改信息都存到该日志文件中，用于在刷新脏页到磁盘，发生错误时，进行数据恢复使用。

WAL，先写日志，再往磁盘写，这样可以先记录下来

保证刷新脏页发生错误时，可以恢复数据



物理日志：存操作的指令



## undo log

保证：原子性

作用：

- 提供回滚
- MVCC



逻辑日志：存操作的指令的反向操作

- Undo log销毁：undo log在事务执行时产生，事务提交时，并不会立即别除undo log,因为这些日志可能还用于MVCC。
- Undo log存储：undo log采用段的方式进行管理和记录，存放在前面介绍的rollback segment回滚段中，内部包含1024个undo log segment。



## MVCC

隔离级别

### 概念

#### 当前读：读取的记录是最新版本，加锁防止别人修改。

- `select xxx lock in share mode`
- for update
- update
- insert
- delete

#### 快照读

快照读

简单的select(不加锁)就是快照读，快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。

- Read Committed:每次select,都生成一个快照读。
- Repeatable Read:开启事务后第一个select语句才是快照读的地方。
- Serializable:快照读会退化为当前读。

#### MVCC

全称Multi--Version Concurrency Control，多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为MySQL实现。

MvCC提供了一个非阻塞读功能。MVCC的具体实现，还需要依赖于：

- 数据库记录中的三个隐式字段、
- undo log日志、
- readview。



### 隐藏字段

- `DB_TRX_ID`：最近修改事务ID
- `DB_ROLL_PTR`：回滚指针，指向这条记录的上一个版本（在undo log中），配合undo log，指向上一个版本
- `DB_ROW_ID`：隐藏主键，如果表本身没有指定主键，将会生成该隐藏字段

`ibd2sdi xxx.ibd`可以查看这张表的定义格式，可以看到所有的字段包括隐藏字段



### undo log

回滚日志，在insert、update、delete的时候产生的便于数据回滚的日志。

- 当insert的时候，产生的undo log日志只在回滚时需要，在事务提交后，可被立即删除。
- 而update、delete的时候，产生的undo log日志不仅在回滚时需要，在快照读时也需要，不会立即被删除。



undo log中是一个版本链（链表）

不同事务或相同事务对同一条记录进行修改，会导致该记录的undolog生成一条记录版本链表，链表的头部是最新的1旧记录，链表尾部是最早的旧记录。



### readview

读视图，是快照读SQL执行时MVCC提取数据的依据，记录并维护系统当前活动的事务（未提交的）id。确定当前快照读应该读哪个版本

ReadView中包含了四个核心字段：

| 字段           | 含义                                             |
| -------------- | ------------------------------------------------ |
| m_ids          | 当前活跃的事务ID集合                             |
| min_trx_id     | 最小活跃事务ID                                   |
| max_trx_id     | 预分配事务D,当前最大事务ID+1(因为事务ID是自增的) |
| creator_trx_id | ReadView创建者的事务ID                           |



![截屏2023-02-25 13.01.59](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/3978/%E6%88%AA%E5%B1%8F2023-02-25%2013.01.59.png)



不同的隔离级别，生成Readview的时机不同：

- READ COMMITTED：在事务中每一次执行快照读时生成ReadView。
- REPEATABLE READ：仅在事务中第一次执行快照读时生成Readview，后续复用该Readview,

